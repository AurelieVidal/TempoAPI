{% extends "base_template.html" %}

{% block title %}Email Validé{% endblock %}

{% block main %}
    <h2>Ton email est validé !</h2>
    <p>
        Il ne reste plus qu’à valider ton numéro de téléphone et tu pourras profiter pleinement de Tempo&nbsp;!
        <br/>
        Nous venons de t’envoyer un SMS avec un code, renseigne-le ici&nbsp;:
    </p>

    <div id="sign-in-button" style="display:none;"></div>

    <div class="input_form">
        <form id="smsForm">
            <input type="hidden" id="userId" value="{{ user_id }}" >
            <input type="hidden" id="userPhone" value="{{ phone }}" >
            <input type="hidden" id="token" value="{{ token }}" >
            <input type="text" id="inputCode" maxlength="6">
            <button type="submit">Valider</button>
        </form>
        <p class="error" id="error-message">Attention, tu n'a pas renseigné le code...</p>
    </div>

    <div class="resend">
        <p class="resend_message">Tu n'a rien reçu sur ton télephone ?</p>
        <button id="resend_button" class="resend_phone_button" type="submit">Me renvoyer un code</button>
    </div>
{% endblock %}

{% block scripts %}
    <script
            src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"
            integrity="sha384-ajMUFBUFMCyjh8uxJg6bkGcKe9RTolyjwbxB3yES0QQMenP3Oztj/W9vA2SJPcIh"
            crossorigin="anonymous">
    </script>
    <script
            src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"
            integrity="sha384-xD1t9dGSVKobUztxDkv6xUI0H4AnFz0NxwlgDJJ7FDlblG9xxr1Z9iauCZuJYj6p"
            crossorigin="anonymous">
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAqJY9muufM0IIi3q5XJ26B46UFZQJiUeo",
          authDomain: "tempo-6bc72.firebaseapp.com",
          projectId: "tempo-6bc72",
          storageBucket: "tempo-6bc72.appspot.com",
          messagingSenderId: "939183919282",
          appId: "1:939183919282:web:19fc49966a8ab6b34af9ab",
          measurementId: "G-9E5NWCV3WG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        window.onload = function () {
          const phoneNumber = document.getElementById("userPhone").value;
          const signInButton = document.getElementById("sign-in-button");

          window.recaptchaVerifier = new RecaptchaVerifier(signInButton, {
            size: "invisible",
            callback: (response) => {
              console.log("reCAPTCHA validé");
            },
          }, auth);

          const appVerifier = window.recaptchaVerifier;

          signInWithPhoneNumber(auth, phoneNumber, appVerifier)
            .then((confirmationResult) => {
              window.confirmationResult = confirmationResult;
            })
            .catch((error) => {
              console.error("Erreur envoi SMS:", error);
            });
        };
    </script>

    <script src="{{ url_for('static', filename='js/check_user_info.js') }}"></script>
{% endblock %}